<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Dashboard - bitesbot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --blue: #58a6ff;
      --purple: #a371f7;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    h1 {
      font-size: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    h1 span { font-size: 14px; color: var(--muted); font-weight: 400; }
    
    .actions {
      display: flex;
      gap: 12px;
    }
    
    button {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    
    button:hover { background: var(--border); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary { background: var(--green); color: #000; border-color: var(--green); }
    button.primary:hover { background: #2ea043; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 600;
    }
    
    .stat-card .value.green { color: var(--green); }
    .stat-card .value.red { color: var(--red); }
    .stat-card .value.yellow { color: var(--yellow); }
    .stat-card .value.blue { color: var(--blue); }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
    
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .panel-body {
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .test-file {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
    }
    
    .test-file:hover { background: rgba(255,255,255,0.03); }
    .test-file:last-child { border-bottom: none; }
    
    .test-file .name {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .test-file .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 16px;
    }
    
    .test-file .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge.pass { background: rgba(63,185,80,0.15); color: var(--green); }
    .badge.fail { background: rgba(248,81,73,0.15); color: var(--red); }
    .badge.skip { background: rgba(210,153,34,0.15); color: var(--yellow); }
    .badge.e2e { background: rgba(163,113,247,0.15); color: var(--purple); }
    .badge.unit { background: rgba(88,166,255,0.15); color: var(--blue); }
    
    .test-cases {
      padding: 0 20px 12px 20px;
      display: none;
    }
    
    .test-file.expanded .test-cases { display: block; }
    
    .test-case {
      padding: 6px 0;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
    }
    
    .test-case .icon { font-size: 14px; }
    .test-case.pass .icon { color: var(--green); }
    .test-case.fail .icon { color: var(--red); }
    .test-case.fail { color: var(--text); }
    
    .activity-item {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .activity-item:last-child { border-bottom: none; }
    
    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .activity-icon.pass { background: rgba(63,185,80,0.15); color: var(--green); }
    .activity-icon.fail { background: rgba(248,81,73,0.15); color: var(--red); }
    .activity-icon.run { background: rgba(88,166,255,0.15); color: var(--blue); }
    
    .activity-content { flex: 1; min-width: 0; }
    .activity-title { font-size: 14px; margin-bottom: 2px; }
    .activity-time { font-size: 12px; color: var(--muted); }
    
    .running-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(88,166,255,0.15);
      border-radius: 6px;
      font-size: 13px;
      color: var(--blue);
    }
    
    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--blue);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: var(--muted);
    }
    
    .progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 16px;
    }
    
    .progress-bar .fill {
      height: 100%;
      background: var(--green);
      transition: width 0.3s;
    }
    
    .full-width { grid-column: 1 / -1; }
    
    .console {
      background: #000;
      padding: 16px 20px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      color: var(--muted);
    }
    
    .console .pass { color: var(--green); }
    .console .fail { color: var(--red); }
    .console .info { color: var(--blue); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        üß™ Test Dashboard
        <span>bitesbot ‚Ä¢ tg-gateway</span>
      </h1>
      <div class="actions">
        <button onclick="runTests('unit')" id="btn-unit">
          <span>‚ö°</span> Run Unit Tests
        </button>
        <button onclick="runTests('e2e')" id="btn-e2e">
          <span>üîó</span> Run E2E Tests
        </button>
        <button onclick="runTests('all')" class="primary" id="btn-all">
          <span>‚ñ∂</span> Run All Tests
        </button>
      </div>
    </header>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Total Tests</div>
        <div class="value blue" id="stat-total">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Passing</div>
        <div class="value green" id="stat-pass">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Failing</div>
        <div class="value red" id="stat-fail">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Test Files</div>
        <div class="value" id="stat-files">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Duration</div>
        <div class="value" id="stat-duration">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Success Rate</div>
        <div class="value green" id="stat-rate">-</div>
      </div>
    </div>
    
    <div class="grid">
      <div class="panel">
        <div class="panel-header">
          <span>üìÅ Test Files</span>
          <span id="file-count" style="color: var(--muted); font-weight: 400;">-</span>
        </div>
        <div class="panel-body" id="test-files">
          <div class="empty-state">Load test results to see files</div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <span>üìä Recent Activity</span>
        </div>
        <div class="panel-body" id="activity">
          <div class="empty-state">No test runs yet</div>
        </div>
      </div>
      
      <div class="panel full-width">
        <div class="panel-header">
          <span>üíª Console Output</span>
          <span id="run-status"></span>
        </div>
        <div class="console" id="console">Waiting for test run...</div>
      </div>
    </div>
  </div>
  
  <script>
    let testResults = null;
    let activity = [];
    
    // Load from localStorage
    try {
      const saved = localStorage.getItem('testDashboard');
      if (saved) {
        const data = JSON.parse(saved);
        testResults = data.results;
        activity = data.activity || [];
        renderAll();
      }
    } catch (e) {}
    
    function save() {
      localStorage.setItem('testDashboard', JSON.stringify({
        results: testResults,
        activity: activity.slice(0, 20)
      }));
    }
    
    async function runTests(type) {
      const btns = document.querySelectorAll('button');
      btns.forEach(b => b.disabled = true);
      
      const statusEl = document.getElementById('run-status');
      const consoleEl = document.getElementById('console');
      
      statusEl.innerHTML = '<span class="running-indicator"><span class="spinner"></span>Running tests...</span>';
      consoleEl.textContent = '';
      consoleEl.innerHTML = '<span class="info">Starting test run...</span>\n';
      
      const cmd = type === 'unit' ? 'test:unit' : type === 'e2e' ? 'test:e2e' : 'test';
      
      try {
        const response = await fetch('/api/run-tests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type })
        });
        
        const data = await response.json();
        
        if (data.success) {
          testResults = data.results;
          
          activity.unshift({
            type: data.results.numFailedTests === 0 ? 'pass' : 'fail',
            title: `${type === 'all' ? 'All' : type.toUpperCase()} tests: ${data.results.numPassedTests}/${data.results.numTotalTests} passed`,
            time: new Date().toISOString(),
            duration: data.duration
          });
          
          save();
          renderAll();
          
          consoleEl.innerHTML = formatConsoleOutput(data);
          statusEl.innerHTML = data.results.numFailedTests === 0 
            ? '<span class="badge pass">‚úì All tests passed</span>'
            : '<span class="badge fail">‚úó Some tests failed</span>';
        } else {
          consoleEl.innerHTML = `<span class="fail">Error: ${data.error}</span>\n${data.stderr || ''}`;
          statusEl.innerHTML = '<span class="badge fail">‚úó Test run failed</span>';
        }
      } catch (err) {
        consoleEl.innerHTML = `<span class="fail">Failed to run tests: ${err.message}</span>\n\nMake sure the server is running:\n  node server.js`;
        statusEl.innerHTML = '<span class="badge fail">‚úó Connection error</span>';
      }
      
      btns.forEach(b => b.disabled = false);
    }
    
    function formatConsoleOutput(data) {
      if (!data.results) return data.stdout || '';
      
      let output = '';
      const r = data.results;
      
      output += `<span class="info">Test Suites: </span>`;
      if (r.numPassedTestSuites) output += `<span class="pass">${r.numPassedTestSuites} passed</span>, `;
      if (r.numFailedTestSuites) output += `<span class="fail">${r.numFailedTestSuites} failed</span>, `;
      output += `${r.numTotalTestSuites} total\n`;
      
      output += `<span class="info">Tests:       </span>`;
      if (r.numPassedTests) output += `<span class="pass">${r.numPassedTests} passed</span>, `;
      if (r.numFailedTests) output += `<span class="fail">${r.numFailedTests} failed</span>, `;
      output += `${r.numTotalTests} total\n`;
      
      output += `<span class="info">Duration:    </span>${(data.duration / 1000).toFixed(2)}s\n\n`;
      
      // Show failed tests
      if (r.numFailedTests > 0 && r.testResults) {
        output += `<span class="fail">Failed Tests:</span>\n`;
        for (const file of r.testResults) {
          for (const test of file.assertionResults || []) {
            if (test.status === 'failed') {
              output += `  <span class="fail">‚úó ${test.fullName || test.title}</span>\n`;
              if (test.failureMessages) {
                for (const msg of test.failureMessages) {
                  output += `    ${msg.slice(0, 200)}...\n`;
                }
              }
            }
          }
        }
      }
      
      return output;
    }
    
    function renderAll() {
      renderStats();
      renderFiles();
      renderActivity();
    }
    
    function renderStats() {
      if (!testResults) return;
      
      const r = testResults;
      document.getElementById('stat-total').textContent = r.numTotalTests;
      document.getElementById('stat-pass').textContent = r.numPassedTests;
      document.getElementById('stat-fail').textContent = r.numFailedTests;
      document.getElementById('stat-files').textContent = r.numTotalTestSuites;
      
      const rate = r.numTotalTests > 0 
        ? Math.round((r.numPassedTests / r.numTotalTests) * 100) 
        : 0;
      document.getElementById('stat-rate').textContent = `${rate}%`;
      document.getElementById('stat-rate').className = `value ${rate === 100 ? 'green' : rate >= 80 ? 'yellow' : 'red'}`;
      
      // Duration from activity
      const lastRun = activity[0];
      if (lastRun?.duration) {
        document.getElementById('stat-duration').textContent = `${(lastRun.duration / 1000).toFixed(1)}s`;
      }
    }
    
    function renderFiles() {
      const container = document.getElementById('test-files');
      
      if (!testResults?.testResults) {
        container.innerHTML = '<div class="empty-state">Run tests to see results</div>';
        return;
      }
      
      const files = testResults.testResults;
      document.getElementById('file-count').textContent = `${files.length} files`;
      
      container.innerHTML = files.map(file => {
        const name = file.name.split('/').pop();
        const isE2E = name.includes('.e2e.');
        const passed = file.assertionResults?.filter(t => t.status === 'passed').length || 0;
        const failed = file.assertionResults?.filter(t => t.status === 'failed').length || 0;
        const total = file.assertionResults?.length || 0;
        const duration = file.endTime - file.startTime;
        
        const tests = (file.assertionResults || []).map(t => `
          <div class="test-case ${t.status}">
            <span class="icon">${t.status === 'passed' ? '‚úì' : '‚úó'}</span>
            <span>${t.title}</span>
          </div>
        `).join('');
        
        return `
          <div class="test-file" onclick="this.classList.toggle('expanded')">
            <div class="name">
              ${name}
              <span class="badge ${isE2E ? 'e2e' : 'unit'}">${isE2E ? 'E2E' : 'Unit'}</span>
              <span class="badge ${failed ? 'fail' : 'pass'}">${failed ? `${failed} failed` : `${passed} passed`}</span>
            </div>
            <div class="meta">
              <span>${total} tests</span>
              <span>${duration}ms</span>
            </div>
            <div class="test-cases">${tests}</div>
          </div>
        `;
      }).join('');
    }
    
    function renderActivity() {
      const container = document.getElementById('activity');
      
      if (!activity.length) {
        container.innerHTML = '<div class="empty-state">No test runs yet</div>';
        return;
      }
      
      container.innerHTML = activity.slice(0, 10).map(item => {
        const time = new Date(item.time);
        const timeStr = time.toLocaleTimeString();
        const dateStr = time.toLocaleDateString();
        
        return `
          <div class="activity-item">
            <div class="activity-icon ${item.type}">
              ${item.type === 'pass' ? '‚úì' : item.type === 'fail' ? '‚úó' : '‚ñ∂'}
            </div>
            <div class="activity-content">
              <div class="activity-title">${item.title}</div>
              <div class="activity-time">${timeStr} ‚Ä¢ ${dateStr}${item.duration ? ` ‚Ä¢ ${(item.duration/1000).toFixed(1)}s` : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    renderAll();
  </script>
</body>
</html>
